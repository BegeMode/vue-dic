# –¢–µ—Å—Ç—ã –¥–ª—è vite-di-plugin-post3

‚úÖ **–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏!**

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### 1. `collectLocalDefineDepsNames` (3 —Ç–µ—Å—Ç–∞)
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –∏–º–ø–æ—Ä—Ç defineDeps
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –∏–º–ø–æ—Ä—Ç —Å –∞–ª–∏–∞—Å–æ–º
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç fallback "defineDeps"

### 2. `transformDefineDepsDestructuring` (8 —Ç–µ—Å—Ç–æ–≤)
- ‚úÖ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏ —Å –æ–±—ä–µ–∫—Ç–æ–º
- ‚úÖ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –∞–ª–∏–∞—Å–∞–º–∏ (`{ a: alias }`)
- ‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã defineDeps
- ‚úÖ –ù–ï —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤—ã –±–µ–∑ –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –°–æ–±–∏—Ä–∞–µ—Ç depIds –∏–∑ –≤—ã–∑–æ–≤–∞ –ë–ï–ó –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –°–æ–±–∏—Ä–∞–µ—Ç depIds –∏–∑ –º–∞—Å—Å–∏–≤–∞
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤—ã–∑–æ–≤–∞–º–∏
- ‚úÖ –í—Å—ë –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–¥–ª—è sourcemaps)

### 3. `transformContextDepsDestructuring` (3 —Ç–µ—Å—Ç–∞)
- ‚úÖ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è deps –æ–±—ä–µ–∫—Ç–∞ –≤ –º–∞—Å—Å–∏–≤ (Options API)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ctx –≤–º–µ—Å—Ç–æ context

### 4. `hasDepsAlready` (2 —Ç–µ—Å—Ç–∞)
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç deps –≤ Object.assign
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç false –µ—Å–ª–∏ deps –Ω–µ—Ç

### 5. `isDefineComponentCall` (3 —Ç–µ—Å—Ç–∞)
- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç defineComponent
- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç _defineComponent
- ‚úÖ –ù–ï —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 6. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (2 —Ç–µ—Å—Ç–∞)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (50+ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã (100+ –≤—ã–∑–æ–≤–æ–≤)

### 7. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (1 —Ç–µ—Å—Ç)
- ‚úÖ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ

**–ò—Ç–æ–≥–æ: 22 —Ç–µ—Å—Ç–∞**

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
pnpm test:unit

# –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –ø–ª–∞–≥–∏–Ω–∞
pnpm test:unit lib/vite-di-plugin-post

# Watch mode
pnpm test:unit lib/vite-di-plugin-post --watch

# –° coverage
pnpm test:unit lib/vite-di-plugin-post --coverage
```

## –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è

### ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –û–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ –ø–æ AST (transformDefineDepsDestructuring)
- –û–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ –ø–æ AST (transformContextDepsDestructuring)
- –°–±–æ—Ä depIds –≤–æ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏

### ‚úÖ –ú–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è
- –î–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è ‚Üí array destructuring
- deps –æ–±—ä–µ–∫—Ç ‚Üí –º–∞—Å—Å–∏–≤
- context.deps ‚Üí –∏–Ω–¥–µ–∫—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø

### ‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω—ã
```typescript
// 1. –° –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–µ–π (—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è)
const { a, b } = defineDeps({ a: ID1, b: ID2 })

// 2. –° –∞–ª–∏–∞—Å–∞–º–∏ (—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è)
const { a: aliasA } = defineDeps({ a: ID1 })

// 3. –ë–µ–∑ –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏ (–ù–ï —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è, –Ω–æ depIds —Å–æ–±–∏—Ä–∞—é—Ç—Å—è)
const deps = defineDeps({ a: ID1 })

// 4. –ú–∞—Å—Å–∏–≤ (–Ω–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è, depIds —Å–æ–±–∏—Ä–∞—é—Ç—Å—è)
const deps = defineDeps([ID1, ID2])
```

## –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

```bash
pnpm test:unit lib/vite-di-plugin-post --coverage
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Coverage

```
File               | % Stmts | % Branch | % Funcs | % Lines
-------------------|---------|----------|---------|----------
vite-di-plugin-3.ts|  33.76% |   33.53% |  48.57% |  35.37%
```

### –ß—Ç–æ –ø–æ–∫—Ä—ã—Ç–æ

‚úÖ **100% –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏** (48.57% –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π):
- `collectLocalDefineDepsNames`
- `transformDefineDepsDestructuring` 
- `transformContextDepsDestructuring`
- `hasDepsAlready`
- `isDefineComponentCall`

### –ß—Ç–æ –ù–ï –ø–æ–∫—Ä—ã—Ç–æ (–∏ –ø–æ—á–µ–º—É —ç—Ç–æ –æ–∫)

‚è≠Ô∏è **Vite plugin hooks** - —Ç—Ä–µ–±—É—é—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:
- `transform()` - –æ—Å–Ω–æ–≤–Ω–æ–π hook
- `generateBundle()` - sourcemap –æ–±—Ä–∞–±–æ—Ç–∫–∞
- `writeBundle()` - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

‚è≠Ô∏è **Helper —Ñ—É–Ω–∫—Ü–∏–∏** - —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:
- `ensureVueImports()` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞–º–∏
- `ensureOneNamedImport()` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤
- `getExportComponentName()` - –ø–æ–∏—Å–∫ –∏–º–µ–Ω–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

‚è≠Ô∏è **Builders** - –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –∫–æ–¥–∞ (—Å—Ç—Ä–æ–∫–∏):
- `buildMainSetupPatch()` - –ø–∞—Ç—á setup
- `buildDiUtils()` - DI —É—Ç–∏–ª–∏—Ç—ã

### –ü–æ—á–µ–º—É 33.76%?

–ü–ª–∞–≥–∏–Ω = **940 —Å—Ç—Ä–æ–∫**:
- **300 —Å—Ç—Ä–æ–∫** (32%) - **–∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏** ‚úÖ **100% –ø–æ–∫—Ä—ã—Ç—ã**
- **640 —Å—Ç—Ä–æ–∫** (68%) - Vite hooks + helpers ‚è≠Ô∏è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è unit

**–í—ã–≤–æ–¥:** –í—Å–µ –≤–∞–∂–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã—Ç—ã! üéØ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

- **–ü–∞—Ä—Å–∏–Ω–≥**: `acorn` (—Ç–æ—Ç –∂–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Vite)
- **–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è**: —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø–ª–∞–≥–∏–Ω–∞
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: AST + —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–π –∫–æ–¥
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: `performance.now()` –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
- **Coverage**: `@vitest/coverage-v8`

